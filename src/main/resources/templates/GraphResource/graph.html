{@String title}
{@String currentPage}
{@String userName}
{#include base}

<div class="uk-flex uk-flex-between uk-flex-middle uk-margin-bottom">
    <h2 class="uk-heading-small uk-margin-remove">
        <span uk-icon="icon: git-branch; ratio: 1.5"></span>
        Relationship Network
    </h2>

    <!-- Toolbar -->
    <div class="uk-button-group">
        <button id="layout-cose" class="uk-button uk-button-small uk-button-default" title="Force Layout">
            <span uk-icon="move"></span>
        </button>
        <button id="layout-circle" class="uk-button uk-button-small uk-button-default" title="Circular Layout">
            <span uk-icon="refresh"></span>
        </button>
        <button id="layout-grid" class="uk-button uk-button-small uk-button-default" title="Grid Layout">
            <span uk-icon="grid"></span>
        </button>
        <button id="btn-export" class="uk-button uk-button-small uk-button-primary" title="Export PNG">
            <span uk-icon="download"></span> Export
        </button>
    </div>
</div>

<!-- Search and Filter Bar -->
<div class="uk-grid-small uk-margin-bottom" uk-grid>
    <div class="uk-width-1-3@m">
        <div class="uk-inline uk-width-1-1">
            <span class="uk-form-icon" uk-icon="icon: search"></span>
            <input id="graph-search" class="uk-input uk-form-small"
                   type="text" placeholder="Search by name...">
        </div>
    </div>
    <div class="uk-width-1-3@m">
        <select id="relationship-filter" class="uk-select uk-form-small">
            <option value="">All Relationships</option>
            <!-- Populated by JavaScript -->
        </select>
    </div>
    <div class="uk-width-1-3@m uk-text-muted uk-text-small uk-flex uk-flex-middle">
        <span id="graph-stats">Loading...</span>
    </div>
</div>

<!-- Graph Container -->
<div class="uk-position-relative">
    <!-- Loading State -->
    <div id="graph-loading" class="uk-flex uk-flex-center uk-flex-middle uk-background-muted"
         style="height: 600px;">
        <div class="uk-text-center">
            <div uk-spinner="ratio: 2"></div>
            <p class="uk-margin-top uk-text-muted">Loading graph data...</p>
        </div>
    </div>

    <!-- Cytoscape Container (hidden until loaded) -->
    <div id="cy" class="uk-background-muted uk-border-rounded"
         style="width: 100%; height: 600px; display: none;"></div>

    <!-- Minimap Container -->
    <div id="cy-minimap" style="position: absolute; bottom: 10px; right: 10px;
         width: 150px; height: 150px; background: rgba(255,255,255,0.9);
         border: 1px solid #ddd; border-radius: 4px; display: none;"></div>
</div>

<p class="uk-text-muted uk-text-small uk-margin-top">
    <span uk-icon="info"></span>
    Drag nodes to reposition. Scroll to zoom. Right-click for options.
</p>

<!-- Person Details Modal -->
<div id="person-modal" uk-modal>
    <div class="uk-modal-dialog uk-modal-body">
        <button class="uk-modal-close-default" type="button" uk-close></button>
        <div id="person-modal-body">
            <!-- Content populated by JavaScript -->
        </div>
    </div>
</div>

<!-- Cytoscape.js and Extensions -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/cytoscape/3.30.4/cytoscape.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/cytoscape-context-menus@4.1.0/cytoscape-context-menus.min.js"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/cytoscape-context-menus@4.1.0/cytoscape-context-menus.min.css">
<script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/cytoscape-popper@2.0.0/cytoscape-popper.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/tippy.js@6.3.7/dist/tippy-bundle.umd.min.js"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tippy.js@6.3.7/dist/tippy.css">

<!-- Graph Initialization Script -->
{|
<style>
/* Cytoscape tooltip styling */
.tippy-box[data-theme~='cy'] {
    background-color: #333;
    color: white;
    font-size: 12px;
}
.tippy-box[data-theme~='cy'] .tippy-arrow {
    color: #333;
}
/* Context menu customization */
.cy-context-menus-cxt-menu {
    background: white;
    border-radius: 4px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.2);
}
.cy-context-menus-cxt-menuitem {
    padding: 8px 16px;
}
.cy-context-menus-cxt-menuitem:hover {
    background: #f0f0f0;
}
</style>

<script>
(function() {
    const container = document.getElementById('cy');
    const loadingEl = document.getElementById('graph-loading');
    const minimapEl = document.getElementById('cy-minimap');
    const searchInput = document.getElementById('graph-search');
    const filterSelect = document.getElementById('relationship-filter');
    const statsEl = document.getElementById('graph-stats');
    let cy = null;

    // Color mapping by gender
    const colorMap = {
        'F': '#E91E63',  // Pink for Female
        'M': '#2196F3',  // Blue for Male
        'X': '#9E9E9E'   // Gray for Unspecified
    };

    // Cytoscape style definitions
    const cyStyle = [
        {
            selector: 'node',
            style: {
                'background-color': ele => colorMap[ele.data('genderCode')] || '#9E9E9E',
                'label': 'data(name)',
                'width': ele => 20 + Math.log2(ele.data('weight') + 1) * 10,
                'height': ele => 20 + Math.log2(ele.data('weight') + 1) * 10,
                'font-size': '10px',
                'text-valign': 'bottom',
                'text-margin-y': '5px',
                'text-wrap': 'ellipsis',
                'text-max-width': '80px',
                'border-width': 2,
                'border-color': '#fff'
            }
        },
        {
            selector: 'node:selected',
            style: {
                'border-color': '#ffc107',
                'border-width': 4
            }
        },
        {
            selector: 'node.highlighted',
            style: {
                'opacity': 1,
                'z-index': 10
            }
        },
        {
            selector: 'node.faded',
            style: {
                'opacity': 0.2
            }
        },
        {
            selector: 'edge',
            style: {
                'width': 2,
                'line-color': '#aaa',
                'target-arrow-color': '#aaa',
                'target-arrow-shape': 'triangle',
                'curve-style': 'bezier',
                'label': 'data(label)',
                'font-size': '8px',
                'text-rotation': 'autorotate',
                'text-margin-y': '-10px',
                'text-opacity': 0.7
            }
        },
        {
            selector: 'edge.highlighted',
            style: {
                'line-color': '#ffc107',
                'target-arrow-color': '#ffc107',
                'width': 3,
                'opacity': 1,
                'z-index': 10
            }
        },
        {
            selector: 'edge.faded',
            style: {
                'opacity': 0.1
            }
        },
        {
            selector: 'edge.hidden',
            style: {
                'display': 'none'
            }
        }
    ];

    // Fetch and initialize graph
    fetch('/graph/data')
        .then(response => {
            if (!response.ok) throw new Error('Failed to load graph data');
            return response.json();
        })
        .then(graphData => {
            loadingEl.style.display = 'none';
            container.style.display = 'block';
            minimapEl.style.display = 'block';

            // Handle empty state
            if (graphData.nodes.length === 0) {
                container.innerHTML = `
                    <div class="uk-flex uk-flex-center uk-flex-middle" style="height: 100%;">
                        <div class="uk-text-center uk-text-muted">
                            <span uk-icon="icon: warning; ratio: 3"></span>
                            <p class="uk-margin-top">No people found.
                               <a href="/persons">Add some people</a> to see the network graph.</p>
                        </div>
                    </div>
                `;
                minimapEl.style.display = 'none';
                return;
            }

            // Populate filter dropdown
            graphData.relationshipTypes.forEach(type => {
                const option = document.createElement('option');
                option.value = type;
                option.textContent = type;
                filterSelect.appendChild(option);
            });

            // Update stats
            statsEl.textContent = `${graphData.nodes.length} people, ${graphData.edges.length} relationships`;

            // Initialize Cytoscape
            cy = cytoscape({
                container: container,
                elements: {
                    nodes: graphData.nodes,
                    edges: graphData.edges
                },
                style: cyStyle,
                layout: {
                    name: 'cose',
                    animate: true,
                    animationDuration: 500,
                    nodeRepulsion: function(node) { return 8000; },
                    idealEdgeLength: function(edge) { return 100; }
                },
                minZoom: 0.2,
                maxZoom: 3,
                wheelSensitivity: 0.3
            });

            // Make cy available globally for debugging
            window.cy = cy;

            // Initialize extensions
            initContextMenu();
            initTooltips();
            initEventHandlers();
        })
        .catch(error => {
            console.error('Graph loading error:', error);
            loadingEl.innerHTML = `
                <div class="uk-text-center uk-text-danger">
                    <span uk-icon="icon: warning; ratio: 3"></span>
                    <p class="uk-margin-top">Failed to load graph data.</p>
                    <button class="uk-button uk-button-default" onclick="location.reload()">
                        Retry
                    </button>
                </div>
            `;
        });

    // Context Menu Extension
    function initContextMenu() {
        cy.contextMenus({
            menuItems: [
                {
                    id: 'view-details',
                    content: '<span uk-icon="icon: user; ratio: 0.8"></span> View Details',
                    tooltipText: 'View person details',
                    selector: 'node',
                    onClickFunction: function(event) {
                        const node = event.target;
                        showPersonModal(node.data());
                    }
                },
                {
                    id: 'manage-relationships',
                    content: '<span uk-icon="icon: link; ratio: 0.8"></span> Manage Relationships',
                    tooltipText: 'Go to relationship management',
                    selector: 'node',
                    onClickFunction: function(event) {
                        const node = event.target;
                        window.location.href = '/persons/' + node.data('id') + '/relationships';
                    }
                }
            ]
        });
    }

    // Tooltips using Tippy.js
    function initTooltips() {
        // Node tooltips
        cy.nodes().forEach(node => {
            const ref = node.popperRef();
            const content = `<strong>${escapeHtml(node.data('name'))}</strong><br>${escapeHtml(node.data('email') || '')}`;

            const tip = tippy(ref, {
                content: content,
                allowHTML: true,
                theme: 'cy',
                trigger: 'manual',
                arrow: true,
                placement: 'top',
                hideOnClick: false
            });

            node.on('mouseover', () => tip.show());
            node.on('mouseout', () => tip.hide());
            node.tippy = tip;
        });

        // Edge tooltips
        cy.edges().forEach(edge => {
            const ref = edge.popperRef();

            const tip = tippy(ref, {
                content: edge.data('label'),
                theme: 'cy',
                trigger: 'manual',
                arrow: true,
                placement: 'top',
                hideOnClick: false
            });

            edge.on('mouseover', () => tip.show());
            edge.on('mouseout', () => tip.hide());
            edge.tippy = tip;
        });
    }

    // Event handlers
    function initEventHandlers() {
        // Node click - highlight neighborhood
        cy.on('tap', 'node', function(evt) {
            const node = evt.target;
            highlightNeighborhood(node);
        });

        // Background click - reset highlighting
        cy.on('tap', function(evt) {
            if (evt.target === cy) {
                resetHighlighting();
            }
        });
    }

    // Highlight neighborhood
    function highlightNeighborhood(node) {
        cy.elements().removeClass('highlighted faded');
        const neighborhood = node.neighborhood().add(node);
        neighborhood.addClass('highlighted');
        cy.elements().not(neighborhood).addClass('faded');
    }

    // Reset highlighting
    function resetHighlighting() {
        cy.elements().removeClass('highlighted faded');
    }

    // Search functionality
    let searchDebounce;
    searchInput.addEventListener('input', function() {
        clearTimeout(searchDebounce);
        searchDebounce = setTimeout(() => {
            const query = this.value.toLowerCase().trim();

            if (!query) {
                resetHighlighting();
                return;
            }

            const matched = cy.nodes().filter(node =>
                node.data('name').toLowerCase().includes(query)
            );

            if (matched.length > 0) {
                cy.elements().removeClass('highlighted faded');
                matched.addClass('highlighted');
                cy.elements().not(matched).addClass('faded');

                // Center on single match
                if (matched.length === 1) {
                    cy.animate({
                        center: { eles: matched },
                        zoom: 1.5
                    }, { duration: 300 });
                }
            } else {
                cy.elements().addClass('faded');
            }
        }, 300);
    });

    // Filter by relationship type
    filterSelect.addEventListener('change', function() {
        const selectedType = this.value;

        if (!selectedType) {
            cy.edges().removeClass('hidden');
            cy.nodes().removeClass('faded');
            return;
        }

        cy.edges().forEach(edge => {
            if (edge.data('label') === selectedType) {
                edge.removeClass('hidden');
            } else {
                edge.addClass('hidden');
            }
        });

        // Fade orphaned nodes
        cy.nodes().forEach(node => {
            const visibleEdges = node.connectedEdges().filter(e => !e.hasClass('hidden'));
            if (visibleEdges.length === 0) {
                node.addClass('faded');
            } else {
                node.removeClass('faded');
            }
        });
    });

    // Layout buttons
    document.getElementById('layout-cose').addEventListener('click', () => {
        if (cy) cy.layout({ name: 'cose', animate: true, animationDuration: 500 }).run();
    });

    document.getElementById('layout-circle').addEventListener('click', () => {
        if (cy) cy.layout({ name: 'circle', animate: true, animationDuration: 500 }).run();
    });

    document.getElementById('layout-grid').addEventListener('click', () => {
        if (cy) cy.layout({ name: 'grid', animate: true, animationDuration: 500 }).run();
    });

    // Export as PNG
    document.getElementById('btn-export').addEventListener('click', () => {
        if (!cy) return;
        const png = cy.png({ full: false, scale: 2, bg: '#f8f8f8' });
        const link = document.createElement('a');
        const date = new Date().toISOString().split('T')[0];
        link.download = `relationship-graph-${date}.png`;
        link.href = png;
        link.click();
    });

    // Show person details modal
    function showPersonModal(nodeData) {
        const modalBody = document.getElementById('person-modal-body');
        modalBody.innerHTML = `
            <h2 class="uk-modal-title">${escapeHtml(nodeData.name)}</h2>
            ${nodeData.notes ? `<p class="uk-text-muted uk-text-italic">${escapeHtml(nodeData.notes)}</p>` : ''}
            <dl class="uk-description-list uk-description-list-divider uk-margin-top">
                <dt>Email</dt>
                <dd><a href="mailto:${escapeHtml(nodeData.email)}">${escapeHtml(nodeData.email)}</a></dd>
                ${nodeData.phone ? `<dt>Phone</dt><dd>${escapeHtml(nodeData.phone)}</dd>` : ''}
                ${nodeData.dateOfBirth ? `<dt>Date of Birth</dt><dd>${escapeHtml(nodeData.dateOfBirth)}</dd>` : ''}
                ${nodeData.gender ? `<dt>Gender</dt><dd>${escapeHtml(nodeData.gender)}</dd>` : ''}
            </dl>
            <div class="uk-margin-top">
                <a href="/persons/${nodeData.id}/relationships"
                   class="uk-button uk-button-primary uk-modal-close">
                    <span uk-icon="link"></span> Manage Relationships
                </a>
            </div>
        `;
        UIkit.modal('#person-modal').show();
    }

    // HTML escape helper
    function escapeHtml(text) {
        if (!text) return '';
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    // Cleanup on HTMX navigation
    document.body.addEventListener('htmx:beforeSwap', function(evt) {
        if (evt.detail.target.id === 'main-content' && cy) {
            // Destroy tooltips
            cy.nodes().forEach(node => {
                if (node.tippy) node.tippy.destroy();
            });
            cy.edges().forEach(edge => {
                if (edge.tippy) edge.tippy.destroy();
            });
            cy.destroy();
            cy = null;
        }
    });
})();
</script>
|}

{/include}
