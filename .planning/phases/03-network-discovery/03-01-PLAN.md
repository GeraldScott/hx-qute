---
phase: 03-network-discovery
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/main/java/io/archton/scaffold/entity/PersonRelationship.java
  - src/main/java/io/archton/scaffold/repository/PersonRelationshipRepository.java
  - src/main/java/io/archton/scaffold/service/NetworkService.java
  - src/main/java/io/archton/scaffold/router/GraphResource.java
  - src/main/resources/templates/GraphResource/network.html
  - src/main/resources/templates/PersonResource/person.html
autonomous: true

must_haves:
  truths:
    - "User can click View Network on a person row and see that person's direct connections (1st degree)"
    - "User can change depth selector to 2 or 3 and see additional degrees of separation"
    - "Each connection row shows the relationship type (e.g. Collaborator, Spouse, Parent)"
    - "Depth 2+ connections show which intermediate person connects them"
    - "View Network link in person list points to /graph/network/{personId}, not /graph"
  artifacts:
    - path: "src/main/java/io/archton/scaffold/service/NetworkService.java"
      provides: "BFS traversal logic with depth-bounded network discovery"
      contains: "buildNetwork"
    - path: "src/main/resources/templates/GraphResource/network.html"
      provides: "Server-rendered person-centered network view"
      contains: "network-container"
    - path: "src/main/java/io/archton/scaffold/router/GraphResource.java"
      provides: "GET /graph/network/{personId} endpoint"
      contains: "showPersonNetwork"
  key_links:
    - from: "src/main/java/io/archton/scaffold/router/GraphResource.java"
      to: "src/main/java/io/archton/scaffold/service/NetworkService.java"
      via: "@Inject NetworkService + buildNetwork() call"
      pattern: "networkService\\.buildNetwork"
    - from: "src/main/java/io/archton/scaffold/service/NetworkService.java"
      to: "src/main/java/io/archton/scaffold/repository/PersonRelationshipRepository.java"
      via: "findConnectionsForPersonIds() query per depth level"
      pattern: "findConnectionsForPersonIds"
    - from: "src/main/resources/templates/GraphResource/network.html"
      to: "src/main/java/io/archton/scaffold/router/GraphResource.java"
      via: "HTMX hx-get to /graph/network/{id} with depth param"
      pattern: "hx-get.*graph/network"
    - from: "src/main/resources/templates/PersonResource/person.html"
      to: "/graph/network/{personId}"
      via: "View Network button href"
      pattern: "href.*graph/network"
---

<objective>
Implement person-centered network discovery with configurable depth (1-3 degrees of separation), BFS traversal, and server-rendered HTML view.

Purpose: Investigators need to explore a person's connections outward at configurable depth, seeing relationship types on each link and who connects whom at deeper levels. This is the core feature of Phase 3 (NET-01, NET-02, NET-03).

Output: Working person-centered network page at `/graph/network/{personId}` with depth selector, relationship type badges, and "connected through" display for depth 2+.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-network-discovery/03-RESEARCH.md
@.planning/phases/02-pagination/02-01-SUMMARY.md
@docs/ARCHITECTURE.md
@src/main/java/io/archton/scaffold/router/GraphResource.java
@src/main/java/io/archton/scaffold/entity/PersonRelationship.java
@src/main/java/io/archton/scaffold/repository/PersonRelationshipRepository.java
@src/main/resources/templates/GraphResource/graph.html
@src/main/resources/templates/PersonResource/person.html
@src/main/resources/templates/base.html
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement BFS network traversal service, repository method, entity graph, and resource endpoint</name>
  <files>
    src/main/java/io/archton/scaffold/entity/PersonRelationship.java
    src/main/java/io/archton/scaffold/repository/PersonRelationshipRepository.java
    src/main/java/io/archton/scaffold/service/NetworkService.java
    src/main/java/io/archton/scaffold/router/GraphResource.java
  </files>
  <action>
    **1. Add new EntityGraph to PersonRelationship entity (`PersonRelationship.java`):**

    The entity currently has one `@NamedEntityGraph("PersonRelationship.withDetails")` that loads `relatedPerson` (with title subgraph) and `relationship`. For network traversal we also need `sourcePerson` loaded eagerly. Add a second named entity graph using `@NamedEntityGraphs` wrapping both graphs:

    - Keep existing `PersonRelationship.withDetails` graph unchanged
    - Add new `PersonRelationship.withFullDetails` graph that loads ALL three: `sourcePerson` (with title subgraph), `relatedPerson` (with title subgraph), and `relationship`

    The entity class currently uses `@NamedEntityGraph` (singular) annotation. Change to `@NamedEntityGraphs({...})` wrapping both graphs. Each graph's `person-title` subgraph loads `@NamedAttributeNode("title")`.

    **2. Add bidirectional query method to PersonRelationshipRepository (`PersonRelationshipRepository.java`):**

    Add method `findConnectionsForPersonIds(Set<Long> personIds)` that:
    - Returns `List<PersonRelationship>` where `sourcePerson.id IN ?1 OR relatedPerson.id IN ?1`
    - Uses the new `PersonRelationship.withFullDetails` entity graph via `withHint(FETCH_GRAPH_HINT, graph)`
    - Returns empty list if personIds is empty
    - Pass `List.copyOf(personIds)` to the Panache `find()` method (Panache needs a List, not Set, for IN queries)

    **3. Create NetworkService (`NetworkService.java` in service package):**

    Create `@ApplicationScoped` service class with `@Inject PersonRepository` and `@Inject PersonRelationshipRepository`.

    Define Java records as inner types (Java 21):
    - `record NetworkConnection(Person person, Relationship relationship, Person connectedThrough, int depth)` -- one discovered person at a specific depth
    - `record NetworkResult(Person focalPerson, Map<Integer, List<NetworkConnection>> connectionsByDepth, int maxDepth, int totalConnections)` -- full network result

    Implement `public NetworkResult buildNetwork(Long focalPersonId, int maxDepth)`:
    - Clamp maxDepth to range [1, 3] using `Math.max(1, Math.min(maxDepth, 3))`
    - Look up focal person via `personRepository.findById(focalPersonId)`, return null if not found
    - Initialize `Set<Long> visited` with focalPersonId, `Set<Long> currentFrontier` with focalPersonId
    - Loop from depth=1 to maxDepth:
      - Call `personRelationshipRepository.findConnectionsForPersonIds(currentFrontier)`
      - For each PersonRelationship: determine the "other" person (the one NOT in visited). Check `relatedPerson.id` first -- if not visited, that's the new person with `sourcePerson` as the throughPerson. Else check `sourcePerson.id` -- if not visited, that's the new person with `relatedPerson` as the throughPerson. If both are visited, skip.
      - Add new person ID to visited and nextFrontier
      - Create `NetworkConnection` with the new person, relationship type, through-person, and depth
      - After processing all relationships at this depth, store the connections list in the map keyed by depth
      - Set currentFrontier = nextFrontier; break if empty
    - Compute totalConnections by summing all connection lists
    - Return `NetworkResult`

    **Important:** For depth 1, `connectedThrough` will be the focal person themselves (since they are in the frontier). For depth 2+, it will be the intermediate person who was discovered at the previous depth. This is correct behavior -- the template will only show the "Connected Through" column for depth >= 2.

    **4. Add network endpoint to GraphResource (`GraphResource.java`):**

    Add `@Inject NetworkService networkService;`

    Add to the `Templates` inner class:
    ```java
    public static native TemplateInstance network(
        String title, String currentPage, String userName,
        NetworkService.NetworkResult network, int depth,
        boolean hasDepth2, boolean hasDepth3);
    public static native TemplateInstance network$connections(
        NetworkService.NetworkResult network, int depth,
        boolean hasDepth2, boolean hasDepth3);
    ```

    Note: `hasDepth2` and `hasDepth3` are pre-computed booleans (true when depth >= 2, depth >= 3 respectively) because Qute checked templates do not support arithmetic in `{#if}` conditions. This follows the pattern established in Phase 2 (02-01-SUMMARY.md).

    Add method:
    ```java
    @GET
    @Path("/network/{personId}")
    @Produces(MediaType.TEXT_HTML)
    public TemplateInstance showPersonNetwork(
            @PathParam("personId") Long personId,
            @QueryParam("depth") @DefaultValue("1") int depth,
            @HeaderParam("HX-Request") String hxRequest) {

        if (depth < 1 || depth > 3) depth = 1;

        NetworkService.NetworkResult network = networkService.buildNetwork(personId, depth);
        if (network == null) {
            throw new WebApplicationException(Response.Status.NOT_FOUND);
        }

        boolean hasDepth2 = depth >= 2;
        boolean hasDepth3 = depth >= 3;

        if ("true".equals(hxRequest)) {
            return Templates.network$connections(network, depth, hasDepth2, hasDepth3);
        }

        return Templates.network(
            "Network: " + network.focalPerson().getDisplayName(),
            "graph",
            getCurrentUserName(),
            network,
            depth,
            hasDepth2,
            hasDepth3
        );
    }
    ```

    Import the necessary types: `jakarta.ws.rs.DefaultValue`, `jakarta.ws.rs.QueryParam`, `jakarta.ws.rs.HeaderParam`, and `NetworkService` from the service package.
  </action>
  <verify>
    Run `curl http://127.0.0.1:9080/q/health` to trigger Quarkus dev server reload and confirm no compilation errors. If the server is not running, start it first. Then verify the endpoint responds:
    - `curl -s -o /dev/null -w "%{http_code}" -b "quarkus-credential=..." http://127.0.0.1:9080/graph/network/1?depth=1` returns 200 (or use the dev server's test user session).
    - Check server logs for any Hibernate N+1 warnings or entity graph issues.
  </verify>
  <done>
    NetworkService.buildNetwork() returns correct BFS traversal results. GraphResource has /graph/network/{personId} endpoint that accepts depth query parameter (1-3), clamps invalid values, returns 404 for unknown person ID, and detects HX-Request header for fragment responses. PersonRelationship entity has withFullDetails entity graph. Repository has bidirectional query method.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create network template with depth selector and update View Network links</name>
  <files>
    src/main/resources/templates/GraphResource/network.html
    src/main/resources/templates/PersonResource/person.html
  </files>
  <action>
    **1. Create `network.html` template (`src/main/resources/templates/GraphResource/network.html`):**

    This is a full-page Qute template extending `base.html` with a `{#fragment}` for the connections area that HTMX can swap.

    Template parameter declarations at top:
    ```
    {@io.archton.scaffold.service.NetworkService.NetworkResult network}
    {@int depth}
    {@boolean hasDepth2}
    {@boolean hasDepth3}
    ```

    The template structure:

    ```
    {#include base.html}
    {#title}{title}{/title}

    <!-- Page header with person name and back link -->
    <div class="uk-flex uk-flex-between uk-flex-middle uk-margin-bottom">
        <div>
            <h1 class="uk-heading-small uk-margin-remove">
                Network: {network.focalPerson.getDisplayName()}
            </h1>
            <p class="uk-text-meta uk-margin-remove-top">
                {network.totalConnections} connection{#if network.totalConnections != 1}s{/if} found
                at depth {depth}
            </p>
        </div>
        <div>
            <a href="/persons" class="uk-button uk-button-default uk-button-small">
                <span uk-icon="arrow-left"></span> Back to People
            </a>
        </div>
    </div>

    <!-- Depth selector card -->
    <div class="uk-card uk-card-default uk-card-small uk-card-body uk-margin-bottom">
        <div class="uk-grid-small uk-flex-middle" uk-grid>
            <div class="uk-width-auto">
                <label class="uk-form-label">Depth:</label>
            </div>
            <div class="uk-width-auto">
                <select name="depth" class="uk-select uk-form-small uk-form-width-small"
                        hx-get="/graph/network/{network.focalPerson.id}"
                        hx-target="#network-container"
                        hx-push-url="true">
                    <option value="1" {#if depth == 1}selected{/if}>1st Degree</option>
                    <option value="2" {#if depth == 2}selected{/if}>2nd Degree</option>
                    <option value="3" {#if depth == 3}selected{/if}>3rd Degree</option>
                </select>
            </div>
            <div class="uk-width-expand">
                <span class="uk-text-small uk-text-muted">
                    {#if depth == 1}Direct connections only{/if}
                    {#if hasDepth2 && !hasDepth3}Includes friends of friends{/if}
                    {#if hasDepth3}Extended network (3 degrees){/if}
                </span>
            </div>
        </div>
    </div>

    <!-- Network connections container (HTMX swap target) -->
    {#fragment id=connections}
    <div id="network-container">
        {#if network.totalConnections == 0}
            <div class="uk-card uk-card-default uk-card-body uk-text-center">
                <span uk-icon="icon: users; ratio: 3" class="uk-text-muted"></span>
                <p class="uk-text-large uk-text-muted uk-margin-small-top">No connections found</p>
                <p class="uk-text-small uk-text-muted">This person has no recorded relationships.</p>
            </div>
        {#else}
            {#for entry in network.connectionsByDepth.entrySet()}
                {#if !entry.value.isEmpty}
                <div class="uk-margin-bottom">
                    <h3 class="uk-heading-bullet">
                        {#if entry.key == 1}Direct Connections (1st Degree){/if}
                        {#if entry.key == 2}2nd Degree Connections{/if}
                        {#if entry.key == 3}3rd Degree Connections{/if}
                        <span class="uk-badge">{entry.value.size}</span>
                    </h3>
                    <div class="uk-overflow-auto">
                        <table class="uk-table uk-table-hover uk-table-divider uk-table-small uk-table-middle">
                            <thead>
                                <tr>
                                    <th>Person</th>
                                    <th>Relationship</th>
                                    {#if entry.key > 1}
                                    <th>Connected Through</th>
                                    {/if}
                                    <th class="uk-table-shrink">Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {#for conn in entry.value}
                                <tr>
                                    <td>{conn.person.getDisplayName()}</td>
                                    <td>
                                        <span class="uk-label">{conn.relationship.description}</span>
                                    </td>
                                    {#if entry.key > 1}
                                    <td>
                                        <a href="/graph/network/{conn.connectedThrough.id}"
                                           class="uk-link-muted">
                                            {conn.connectedThrough.getDisplayName()}
                                        </a>
                                    </td>
                                    {/if}
                                    <td class="uk-text-nowrap">
                                        <a class="uk-button uk-button-small uk-button-default"
                                           href="/graph/network/{conn.person.id}"
                                           uk-tooltip="View Network">
                                            <span uk-icon="git-fork"></span>
                                        </a>
                                    </td>
                                </tr>
                                {/for}
                            </tbody>
                        </table>
                    </div>
                </div>
                {/if}
            {/for}
        {/if}
    </div>
    {/fragment}

    {/}
    ```

    **CRITICAL Qute template notes:**
    - The `{#fragment id=connections}` block allows HTMX to swap just the connections area when depth changes. The fragment template method `network$connections(...)` corresponds to this fragment.
    - Use `entry.key` and `entry.value` to iterate over the `Map<Integer, List<NetworkConnection>>`.
    - Use `{#if entry.key > 1}` for the "Connected Through" column -- this works in Qute checked templates because it's a simple integer comparison, not arithmetic.
    - Use `conn.person.getDisplayName()` for person names (existing helper on Person entity).
    - Use `conn.relationship.description` for the relationship type label.
    - Use `conn.connectedThrough.getDisplayName()` for the intermediate person.
    - Pre-computed booleans `hasDepth2` and `hasDepth3` for the depth description text, following Phase 2's pattern of avoiding arithmetic in Qute conditions.

    **2. Update "View Network" links in `person.html`:**

    There are TWO places where `href="/graph"` appears for the View Network button:
    - Line ~153 (in the `table` fragment) -- update to `href="/graph/network/{person.id}"`
    - Line ~424 (in the `modal_success_row` fragment) -- update to `href="/graph/network/{person.id}"`

    In the table fragment, the loop variable is `person` (from `{#for person in persons}`).
    In the modal_success_row fragment, the variable is also `person` (from the template parameter).

    Change both occurrences from:
    ```html
    href="/graph"
    ```
    to:
    ```html
    href="/graph/network/{person.id}"
    ```

    Do NOT modify the navigation sidebar link in `fragments/navigation.html` -- that should remain pointing to `/graph` (the show-all D3.js graph page).
  </action>
  <verify>
    Run `curl http://127.0.0.1:9080/q/health` to trigger reload. Then:
    1. Verify network page renders: `curl -s http://127.0.0.1:9080/graph/network/1?depth=1 -b "..." | grep "network-container"` returns content.
    2. Verify person list links updated: `curl -s http://127.0.0.1:9080/persons -b "..." | grep "graph/network"` shows person-specific network URLs.
    3. Verify HTMX fragment swap: `curl -s http://127.0.0.1:9080/graph/network/1?depth=2 -H "HX-Request: true" -b "..."` returns only the connections fragment (no base.html layout).
    4. Verify depth 3: `curl -s http://127.0.0.1:9080/graph/network/1?depth=3 -b "..."` returns extended network.
  </verify>
  <done>
    Network page renders at /graph/network/{personId} with person's name in heading, connection count, depth selector dropdown (1/2/3), and connections grouped by degree. Each connection row shows person name, relationship type badge, and actions. Depth 2+ rows show "Connected Through" column. HTMX depth selector swaps just the connections area. View Network links in person list point to /graph/network/{person.id}. Navigation sidebar still points to /graph for the show-all D3 page.
  </done>
</task>

</tasks>

<verification>
1. Navigate to person list (/persons), click "View Network" on any person row -- goes to /graph/network/{id} (not /graph)
2. Network page shows person's display name in header and connection count
3. Direct connections (1st degree) table displays with person name, relationship type badge, and View Network action button
4. Change depth selector to 2 -- page updates via HTMX showing 2nd degree connections with "Connected Through" column
5. Change depth selector to 3 -- page shows 3rd degree connections
6. Empty state: person with no relationships shows "No connections found" message
7. Each connection's View Network button links to that person's network view
8. Navigation sidebar "Graph" link still goes to /graph (D3 graph unchanged)
9. Server responds with 404 for non-existent person IDs
10. Invalid depth values (0, -1, 99) are clamped to 1
</verification>

<success_criteria>
- NET-01: Person-centered network view shows all direct connections at depth 1
- NET-02: Depth selector allows switching between 1, 2, and 3 degrees of separation
- NET-03: Each connection row displays the relationship type (e.g., Collaborator, Spouse, Parent)
- Depth 2+ connections show intermediate person name in "Connected Through" column
- HTMX partial update works for depth changes (no full page reload)
- View Network links in person list are person-specific
</success_criteria>

<output>
After completion, create `.planning/phases/03-network-discovery/03-01-SUMMARY.md`
</output>
