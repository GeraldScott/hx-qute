---
phase: 02-pagination
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/main/java/io/archton/scaffold/repository/PersonRepository.java
  - src/main/java/io/archton/scaffold/router/PersonResource.java
  - src/main/resources/templates/PersonResource/person.html
autonomous: true

must_haves:
  truths:
    - "Person list displays a configurable number of results per page (10, 25, 50, 100) with 25 as default"
    - "User can navigate forward and backward through pages using Previous/Next and numbered page links"
    - "Page controls show current page number and total pages"
    - "Changing filter text or sort order resets to page 0"
    - "Changing page size resets to page 0 and preserves filter/sort"
    - "Pagination state is bookmarkable via URL query parameters"
    - "After creating a person, the table refreshes to page 0 with default pagination"
    - "After editing a person, the row updates in-place (existing behavior preserved)"
  artifacts:
    - path: "src/main/java/io/archton/scaffold/repository/PersonRepository.java"
      provides: "Paginated query method returning PanacheQuery<Person>"
      contains: "findByFilterPaged"
    - path: "src/main/java/io/archton/scaffold/router/PersonResource.java"
      provides: "Paginated list endpoint with page/size QueryParams and pagination metadata in template calls"
      contains: "Page.of"
    - path: "src/main/resources/templates/PersonResource/person.html"
      provides: "UIkit pagination controls inside table fragment, page size selector in filter form"
      contains: "uk-pagination"
  key_links:
    - from: "PersonResource.list()"
      to: "PersonRepository.findByFilterPaged()"
      via: "PanacheQuery.page(Page.of(page, size))"
      pattern: "findByFilterPaged.*page.*Page\\.of"
    - from: "person.html table fragment"
      to: "PersonResource.list()"
      via: "hx-get with page/size/filter query params"
      pattern: "hx-get=\"/persons\\?page="
    - from: "person.html page size selector"
      to: "PersonResource.list()"
      via: "hx-get with hx-include closest form"
      pattern: "name=\"size\".*hx-get"
---

<objective>
Add server-side pagination to the person list, replacing the current unbounded findByFilter() query with paginated results using Panache's PanacheQuery API, UIkit pagination controls, and HTMX partial updates.

Purpose: The person list currently loads all records into memory. This phase adds pagination to keep the UI manageable and the database queries bounded, addressing the known "unbounded result sets" concern from STATE.md.

Output: Paginated person list with configurable page sizes (10, 25, 50, 100), Previous/Next navigation, numbered page links with ellipsis for large datasets, and URL-driven bookmarkable state.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-pagination/02-RESEARCH.md
@docs/ARCHITECTURE.md
@src/main/java/io/archton/scaffold/repository/PersonRepository.java
@src/main/java/io/archton/scaffold/router/PersonResource.java
@src/main/resources/templates/PersonResource/person.html
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add paginated repository method and update resource with pagination parameters</name>
  <files>
    src/main/java/io/archton/scaffold/repository/PersonRepository.java
    src/main/java/io/archton/scaffold/router/PersonResource.java
  </files>
  <action>
**PersonRepository.java** -- Add a new method `findByFilterPaged` that returns `PanacheQuery<Person>` instead of `List<Person>`. Keep the existing `findByFilter()` method unchanged (it is still used by `modal_success` OOB refresh). The new method reuses the existing `buildOrderBy()` helper:

```java
public PanacheQuery<Person> findByFilterPaged(String filterText, String sortField, String sortDir) {
    String orderBy = buildOrderBy(sortField, sortDir);
    if (filterText != null && !filterText.isBlank()) {
        String pattern = "%" + filterText.toLowerCase().trim() + "%";
        return find(
            "LOWER(firstName) LIKE ?1 OR LOWER(lastName) LIKE ?1 OR LOWER(email) LIKE ?1 " + orderBy,
            pattern
        );
    }
    return find("FROM Person " + orderBy);
}
```

Add import: `import io.quarkus.hibernate.orm.panache.PanacheQuery;`

**PersonResource.java** -- Make these changes:

1. Add imports: `import io.quarkus.hibernate.orm.panache.PanacheQuery;`, `import io.quarkus.panache.common.Page;`, `import jakarta.ws.rs.DefaultValue;`

2. Update the `Templates` inner class signatures:
   - `person(...)`: Add `int page, int size, int totalPages, long totalCount` after `sortDir`
   - `person$table(...)`: Add `int currentPage, int pageSize, int totalPages, long totalCount` after `filterText`
   - `person$modal_success(...)`: Add `int currentPage, int pageSize, int totalPages, long totalCount` after `filterText`

3. Update `list()` method:
   - Add parameters: `@QueryParam("page") @DefaultValue("0") int page` and `@QueryParam("size") @DefaultValue("25") int size`
   - Clamp size to allowed values: `if (size != 10 && size != 25 && size != 50 && size != 100) { size = 25; }`
   - Replace `personRepository.findByFilter(filter, sortField, sortDir)` with:
     ```java
     PanacheQuery<Person> query = personRepository.findByFilterPaged(filter, sortField, sortDir);
     query.page(Page.of(page, size));
     List<Person> persons = query.list();
     int totalPages = query.pageCount();
     long totalCount = query.count();
     ```
   - Update HTMX return: `Templates.person$table(persons, filter, page, size, totalPages, totalCount)`
   - Update full page return: add `page, size, totalPages, totalCount` to the `Templates.person(...)` call

4. Update `create()` method: After persist, use paginated query for OOB refresh (reset to page 0, size 25):
   ```java
   PanacheQuery<Person> refreshQuery = personRepository.findByFilterPaged(null, null, null);
   refreshQuery.page(Page.of(0, 25));
   List<Person> persons = refreshQuery.list();
   int totalPages = refreshQuery.pageCount();
   long totalCount = refreshQuery.count();
   return Templates.person$modal_success("Person created successfully.", persons, null, 0, 25, totalPages, totalCount);
   ```

5. Keep `update()` unchanged -- it uses `modal_success_row` for in-place row update, which has no pagination dependency.

6. Add a helper method for the ellipsis page window (used by templates). Add this as a static utility method or compute in the list() method and pass to template:
   ```java
   /**
    * Compute visible page numbers for pagination with ellipsis.
    * Returns list of page indices (0-indexed). -1 indicates ellipsis placeholder.
    */
   private List<Integer> computePageWindow(int currentPage, int totalPages) {
       List<Integer> pages = new java.util.ArrayList<>();
       if (totalPages <= 7) {
           for (int i = 0; i < totalPages; i++) pages.add(i);
           return pages;
       }
       // Always show first page
       pages.add(0);
       if (currentPage > 2) pages.add(-1); // ellipsis
       // Window around current page
       for (int i = Math.max(1, currentPage - 1); i <= Math.min(totalPages - 2, currentPage + 1); i++) {
           pages.add(i);
       }
       if (currentPage < totalPages - 3) pages.add(-1); // ellipsis
       // Always show last page
       pages.add(totalPages - 1);
       return pages;
   }
   ```
   Pass the result as `pageWindow` (type `List<Integer>`) to both `person()` and `person$table()` templates. Add `List<Integer> pageWindow` to those CheckedTemplate signatures.

   Also pass `pageWindow` to `person$modal_success` template.
  </action>
  <verify>
Run `curl -s http://127.0.0.1:9080/q/health` to trigger Quarkus dev mode reload. If server is not running, start it with `./mvnw quarkus:dev -Dquarkus.console.enabled=false` in background. Verify compilation succeeds with no errors in server logs. Then run `curl -v "http://127.0.0.1:9080/persons?page=0&size=10" -H "Cookie: quarkus-credential=..." 2>&1 | head -20` to confirm the endpoint accepts page/size params without errors.
  </verify>
  <done>
PersonRepository has findByFilterPaged() returning PanacheQuery. PersonResource.list() accepts page and size query params, executes paginated query, and passes currentPage, pageSize, totalPages, totalCount, and pageWindow to templates. PersonResource.create() refreshes the OOB table with paginated results (page 0, size 25). All CheckedTemplate signatures updated. Server compiles without errors.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add pagination controls and page size selector to the person template</name>
  <files>
    src/main/resources/templates/PersonResource/person.html
  </files>
  <action>
Update `person.html` to render pagination UI and integrate page size into the filter form.

1. **Add template-level type declarations** at the top of the file for the new variables:
   - `{@int currentPage}` (rename the existing parameter when it appears in fragment)
   - `{@int pageSize}`
   - `{@int totalPages}`
   - `{@long totalCount}`
   - `{@java.util.List<java.lang.Integer> pageWindow}`

   Note: The full-page template at the top already has `{@String sortField}` and `{@String sortDir}`. Add the pagination variables after those. Also add `{@int page}`, `{@int size}` etc. matching the Java parameter names from the `person()` template method.

2. **Add page size selector to the filter form** (inside the existing `<form>` element, before the buttons div). Add it as a new grid column:
   ```html
   <!-- Page Size -->
   <div class="uk-width-auto@s">
       <select class="uk-select" name="size"
               hx-get="/persons"
               hx-target="#person-table-container"
               hx-include="closest form"
               hx-push-url="true"
               hx-vals='{"page": "0"}'>
           <option value="10" {#if size == 10}selected{/if}>10</option>
           <option value="25" {#if size == 25}selected{/if}>25</option>
           <option value="50" {#if size == 50}selected{/if}>50</option>
           <option value="100" {#if size == 100}selected{/if}>100</option>
       </select>
   </div>
   ```
   Note: `hx-vals='{"page": "0"}'` ensures page resets to 0 when size changes. The `hx-include="closest form"` captures filter and sort values.

3. **Add a hidden page input to the filter form** that resets to 0 on form submission (so filter/sort changes reset pagination):
   ```html
   <input type="hidden" name="page" value="0" />
   ```
   Place this inside the form but NOT sent by the page size selector (it uses hx-vals to override).

4. **Update the table fragment** (`{#fragment id='table' rendered=false}`):
   - Add type declarations for the new variables:
     ```
     {@int currentPage}
     {@int pageSize}
     {@int totalPages}
     {@long totalCount}
     {@java.util.List<java.lang.Integer> pageWindow}
     ```
   - After the closing `</div>` of the `uk-overflow-auto` table wrapper and before `{/if}` (the end of the non-empty branch), add the record count summary and pagination controls:

     ```html
     <!-- Record count and pagination info -->
     <div class="uk-flex uk-flex-between uk-flex-middle uk-margin-small-top">
         <span class="uk-text-meta">{totalCount} record{#if totalCount != 1}s{/if}</span>
         {#if totalPages > 1}
         <span class="uk-text-meta">Page {currentPage + 1} of {totalPages}</span>
         {/if}
     </div>

     <!-- Pagination controls -->
     {#if totalPages > 1}
     <nav aria-label="Pagination" class="uk-margin-small-top">
         <ul class="uk-pagination uk-flex-center">
             {! Previous button !}
             {#if currentPage > 0}
             <li>
                 <a hx-get="/persons?page={currentPage - 1}&size={pageSize}&filter={filterText ?: ''}"
                    hx-target="#person-table-container"
                    hx-push-url="true">
                     <span uk-pagination-previous></span>
                 </a>
             </li>
             {#else}
             <li class="uk-disabled"><span><span uk-pagination-previous></span></span></li>
             {/if}

             {! Page numbers with ellipsis !}
             {#for pg in pageWindow}
                 {#if pg == -1}
                 <li class="uk-disabled"><span>...</span></li>
                 {#else if pg == currentPage}
                 <li class="uk-active"><span aria-current="page">{pg + 1}</span></li>
                 {#else}
                 <li>
                     <a hx-get="/persons?page={pg}&size={pageSize}&filter={filterText ?: ''}"
                        hx-target="#person-table-container"
                        hx-push-url="true">
                         {pg + 1}
                     </a>
                 </li>
                 {/if}
             {/for}

             {! Next button !}
             {#if currentPage < totalPages - 1}
             <li>
                 <a hx-get="/persons?page={currentPage + 1}&size={pageSize}&filter={filterText ?: ''}"
                    hx-target="#person-table-container"
                    hx-push-url="true">
                     <span uk-pagination-next></span>
                 </a>
             </li>
             {#else}
             <li class="uk-disabled"><span><span uk-pagination-next></span></span></li>
             {/if}
         </ul>
     </nav>
     {/if}
     ```

5. **Update the modal_success fragment** to pass pagination variables when including the table fragment:
   ```html
   {#include $table persons=persons filterText=filterText currentPage=currentPage pageSize=pageSize totalPages=totalPages totalCount=totalCount pageWindow=pageWindow /}
   ```
   Also add the type declarations for pagination variables to the modal_success fragment.

6. **Ensure the full-page include of the table fragment** also passes the pagination variables. The line `{#include $table /}` in the full page body relies on implicit variable passing from the page scope. Since the full-page template has all these variables in scope (from the `person()` method), the fragment should receive them. However, the variable names in the `person()` Java method must match: use `page` → `currentPage` and `size` → `pageSize` in the template. To handle the naming mismatch, either:
   - Rename the Java params to `currentPage`/`pageSize` (cleaner), OR
   - Pass explicitly: `{#include $table persons=persons filterText=filterText currentPage=page pageSize=size totalPages=totalPages totalCount=totalCount pageWindow=pageWindow /}`

   Use the explicit pass approach to avoid confusion. Update the full-page `{#include $table /}` to explicitly pass all variables.

IMPORTANT: The `{#for pg in pageWindow}` loop iterates over `List<Integer>` values. In Qute, the iteration variable `pg` is an `Integer` and can be compared with `==` to `currentPage` (an `int`). Arithmetic like `{pg + 1}` works in Qute expressions.

IMPORTANT: The search input already has its own `hx-get="/persons"` with `hx-trigger="input changed delay:300ms"` and `hx-include="closest form"`. Because the form has a hidden `<input name="page" value="0">`, every search input change will include `page=0`, correctly resetting pagination on filter changes.
  </action>
  <verify>
Run `curl -s http://127.0.0.1:9080/q/health` to trigger reload. Verify no template compilation errors in server logs. Then test:
1. `curl -s "http://127.0.0.1:9080/persons" | grep -c "uk-pagination"` -- should return 1 or more if records exceed page size
2. `curl -s "http://127.0.0.1:9080/persons?page=0&size=10" -H "HX-Request: true" | grep "uk-pagination"` -- pagination in fragment response
3. `curl -s "http://127.0.0.1:9080/persons?page=0&size=10" | grep 'name="size"'` -- page size selector present
  </verify>
  <done>
The person list renders paginated results with UIkit `uk-pagination` controls (Previous, numbered pages with ellipsis, Next). A page size selector dropdown (10/25/50/100) is in the filter bar. Changing filter/sort resets to page 0. Pagination links use hx-get with hx-push-url for bookmarkable URLs. The modal_success OOB refresh includes pagination. Record count and "Page X of Y" displayed below the table.
  </done>
</task>

</tasks>

<verification>
After both tasks are complete:
1. Navigate to `/persons` -- table shows first 25 records (default), page controls visible if >25 records
2. Click page 2 -- URL updates to `/persons?page=1&size=25`, second page of records displays
3. Change page size to 10 -- URL updates with `size=10&page=0`, shows 10 records
4. Type in search filter while on page 2 -- resets to page 0 with filtered results
5. Click Previous on page 1 -- Previous button is disabled (uk-disabled)
6. Click Next on last page -- Next button is disabled (uk-disabled)
7. Create a new person -- modal closes, table refreshes to page 0 with pagination intact
8. Edit a person -- modal closes, row updates in-place (no full table refresh, pagination unaffected)
9. Delete a person -- row removed in-place (existing OOB delete behavior preserved)
10. Bookmark a paginated URL and reload -- same page and filters display
</verification>

<success_criteria>
- Person list shows configurable results per page (10, 25, 50, 100)
- Users can navigate between pages with Previous/Next and numbered links
- Page controls show "Page X of Y" and total record count
- Pagination state is URL-driven and bookmarkable
- Filter and sort changes reset to page 0
- Create/delete/edit operations interact correctly with pagination
</success_criteria>

<output>
After completion, create `.planning/phases/02-pagination/02-01-SUMMARY.md`
</output>
